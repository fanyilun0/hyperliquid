# Hyperliquid 大户交易监控系统 - 使用说明

## 📋 目录

1. [系统概述](#系统概述)
2. [文件说明](#文件说明)
3. [快速开始](#快速开始)
4. [详细使用](#详细使用)
5. [配置说明](#配置说明)
6. [常见问题](#常见问题)
7. [高级用法](#高级用法)

---

## 系统概述

本系统实现了基于 Hyperliquid 官方 API 的大户交易监控功能，包括：

- ✅ 从排行榜自动筛选正收益交易者
- ✅ 实时监控大户的开仓、平仓等交易行为
- ✅ 准确追踪持仓状态变化
- ✅ 支持多种通知方式和自定义配置

### 核心功能

| 功能 | 说明 |
|------|------|
| 地址筛选 | 从 leaderboard.json 筛选正收益前 N 名 |
| 实时监控 | 通过 WebSocket 监听交易事件 |
| 状态追踪 | 维护每个地址的持仓状态 |
| 行为识别 | 区分开仓、平仓、加仓、减仓等 |

---

## 文件说明

### 核心脚本

| 文件 | 功能 | 使用频率 |
|------|------|---------|
| `filter_top_traders.py` | 筛选大户地址 | 每次更新地址列表 |
| `monitor_whales.py` | 基础监控（简单版） | 日常监控 |
| `monitor_whales_v2.py` | 高级监控（支持配置） | 推荐使用 |

### 配置文件

| 文件 | 说明 | 是否必需 |
|------|------|---------|
| `config.json` | 监控配置 | 可选（有默认值） |
| `leaderboard.json` | 排行榜数据 | 必需 |
| `top_traders_addresses.json` | 筛选结果 | 自动生成 |

### 辅助文件

| 文件 | 说明 |
|------|------|
| `requirements.txt` | Python 依赖 |
| `install.sh` | 安装脚本 |
| `start_monitor.sh` | 启动脚本 |
| `demo.py` | 功能演示 |

### 文档文件

| 文件 | 说明 |
|------|------|
| `README.md` | 项目说明 |
| `QUICKSTART.md` | 快速开始指南 |
| `guide.md` | 技术方案文档 |
| `使用说明.md` | 本文档 |

---

## 快速开始

### 方法一：一键启动（推荐新手）

```bash
# 1. 安装依赖
./install.sh

# 2. 启动监控（会自动筛选地址）
./start_monitor.sh
```

### 方法二：分步执行（推荐进阶用户）

```bash
# 1. 安装依赖
pip3 install -r requirements.txt

# 2. 筛选大户地址
python3 filter_top_traders.py

# 3. 启动监控（基础版）
python3 monitor_whales.py

# 或启动高级版（支持配置文件）
python3 monitor_whales_v2.py
```

---

## 详细使用

### 步骤 1: 准备排行榜数据

**选项 A: 使用现有数据**
如果项目中已有 `leaderboard.json`，可直接使用。

**选项 B: 获取最新数据**
```bash
curl -o leaderboard.json https://stats-data.hyperliquid.xyz/Mainnet/leaderboard
```

**数据结构示例:**
```json
{
  "leaderboardRows": [
    {
      "ethAddress": "0x...",
      "accountValue": "1000000.00",
      "windowPerformances": [
        ["allTime", {
          "pnl": "500000.00",
          "roi": "1.0",
          "vlm": "10000000.00"
        }]
      ]
    }
  ]
}
```

### 步骤 2: 筛选大户地址

```bash
python3 filter_top_traders.py
```

**输出示例:**
```
================================================================================
正收益前10名交易者 (时间窗口: allTime)
================================================================================

排名 #1
  地址: 0x77c3ea550d2da44b120e55071f57a108f8dd5e45
  账户价值: $71,676,909.60
  盈亏 (PnL): $298,525,708.14
  收益率 (ROI): 126.61%
  交易量: $193.33
...
```

**生成文件:**
- `top_traders_addresses.json` - 包含筛选出的地址列表和详细信息

### 步骤 3: 启动监控

**基础版:**
```bash
python3 monitor_whales.py
```

**高级版（推荐）:**
```bash
python3 monitor_whales_v2.py
```

**监控输出示例:**
```
🟢 开仓 | 2025-10-15T14:30:25.123456
   用户: 0x77c3ea55...8dd5e45
   币种: BTC
   方向: 买入
   数量: 1.5
   价格: $67,890.00
   仓位: 0.0000 → 1.5000

🔴 平仓 | 2025-10-15T14:35:12.654321
   用户: 0xfae95f60...c57e3571
   币种: ETH
   方向: 卖出
   数量: 10.0
   价格: $3,456.78
   仓位: 10.0000 → 0.0000
   💰 已实现盈亏: $12,345.67
```

---

## 配置说明

### 筛选配置

编辑 `filter_top_traders.py` 底部:

```python
# 修改这些参数
addresses = get_top_traders(
    top_n=10,              # 筛选前10名
    time_window="allTime"  # 时间窗口
)
```

**time_window 选项:**
- `"day"` - 当日收益
- `"week"` - 本周收益
- `"month"` - 本月收益
- `"allTime"` - 历史总收益（推荐）

### 监控配置

编辑 `config.json`:

```json
{
  "filter": {
    "top_n": 10,
    "time_window": "allTime"
  },
  "monitor": {
    "max_addresses": 10,
    "notify_on_open": true,      // 开仓时通知
    "notify_on_close": true,     // 平仓时通知
    "notify_on_reverse": true,   // 反向开仓时通知
    "notify_on_add": false,      // 加仓时通知
    "notify_on_reduce": false,   // 减仓时通知
    "min_position_size": 0       // 最小仓位阈值
  },
  "notification": {
    "console": true,
    "log_file": "trades.log"
  }
}
```

---

## 常见问题

### Q1: 为什么最多只能监控 10 个地址？

**A:** Hyperliquid API 限制每个 IP 地址最多订阅 10 个用户的 userEvents。

**解决方案:**
- 使用多个 IP 地址（代理池）
- 部署到多台服务器
- 分批轮换监控

### Q2: 如何更新排行榜数据？

**A:** 
```bash
# 手动更新
curl -o leaderboard.json https://stats-data.hyperliquid.xyz/Mainnet/leaderboard

# 或设置定时任务（每小时）
0 * * * * cd /path/to/project && curl -s -o leaderboard.json https://stats-data.hyperliquid.xyz/Mainnet/leaderboard
```

### Q3: 监控程序意外退出怎么办？

**A:** 使用 `screen` 或 `nohup` 保持运行:

```bash
# 使用 screen
screen -S whale_monitor
python3 monitor_whales_v2.py
# Ctrl+A 然后 D 退出，程序继续运行

# 使用 nohup
nohup python3 monitor_whales_v2.py > monitor.log 2>&1 &
```

### Q4: 如何查看历史交易记录？

**A:** 查看日志文件:
```bash
# 实时查看
tail -f trades.log

# 搜索特定地址的交易
grep "0x1234..." trades.log

# 统计开仓次数
grep "开仓" trades.log | wc -l
```

### Q5: 能否监控特定币种的交易？

**A:** 修改 `monitor_whales_v2.py` 中的 `_notify_trade` 方法，添加币种过滤:

```python
def _notify_trade(self, trade_info: Dict):
    # 只监控 BTC 和 ETH
    if trade_info['coin'] not in ['BTC', 'ETH']:
        return
    # ... 其余代码
```

---

## 高级用法

### 1. 多时间窗口对比

创建脚本 `compare_windows.py`:

```python
from filter_top_traders import get_top_traders

windows = ['day', 'week', 'month', 'allTime']

for window in windows:
    print(f"\n{'='*60}")
    print(f"时间窗口: {window}")
    print(f"{'='*60}")
    addresses = get_top_traders(top_n=5, time_window=window)
```

### 2. 导出交易数据到 CSV

修改 `monitor_whales_v2.py`，在 `_notify_trade` 方法中添加:

```python
import csv

def _notify_trade(self, trade_info: Dict):
    # 保存到CSV
    with open('trades.csv', 'a', newline='') as f:
        writer = csv.DictWriter(f, fieldnames=trade_info.keys())
        if f.tell() == 0:  # 文件为空时写入表头
            writer.writeheader()
        writer.writerow(trade_info)
    # ... 其余代码
```

### 3. Telegram 通知集成

安装依赖:
```bash
pip3 install python-telegram-bot
```

添加通知函数:
```python
from telegram import Bot
import asyncio

async def send_telegram_notification(trade_info: Dict):
    bot = Bot(token='YOUR_BOT_TOKEN')
    chat_id = 'YOUR_CHAT_ID'
    
    message = f"""
🔔 交易通知
行为: {trade_info['action']}
币种: {trade_info['coin']}
方向: {trade_info['side']}
数量: {trade_info['size']}
价格: ${trade_info['price']:,.2f}
"""
    await bot.send_message(chat_id=chat_id, text=message)
```

### 4. 数据库存储

使用 SQLite 存储交易历史:

```python
import sqlite3

def init_database():
    conn = sqlite3.connect('trades.db')
    c = conn.cursor()
    c.execute('''
        CREATE TABLE IF NOT EXISTS trades (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            timestamp TEXT,
            user TEXT,
            coin TEXT,
            action TEXT,
            side TEXT,
            size REAL,
            price REAL,
            old_position REAL,
            new_position REAL,
            closed_pnl REAL
        )
    ''')
    conn.commit()
    conn.close()

def save_trade(trade_info: Dict):
    conn = sqlite3.connect('trades.db')
    c = conn.cursor()
    c.execute('''
        INSERT INTO trades (timestamp, user, coin, action, side, size, price, old_position, new_position, closed_pnl)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    ''', (
        trade_info['timestamp'],
        trade_info['user'],
        trade_info['coin'],
        trade_info['action'],
        trade_info['side'],
        trade_info['size'],
        trade_info['price'],
        trade_info['old_position'],
        trade_info['new_position'],
        trade_info['closed_pnl']
    ))
    conn.commit()
    conn.close()
```

---

## 性能优化建议

1. **内存优化**: 定期清理已平仓的持仓记录
2. **网络优化**: 使用稳定的网络连接，考虑使用 VPS
3. **日志管理**: 定期归档和清理日志文件
4. **监控监控**: 添加程序健康检查和自动重启机制

---

## 安全建议

1. ⚠️ 不要在代码中硬编码任何私钥或敏感信息
2. ⚠️ 本系统仅读取公开数据，不执行任何交易
3. ⚠️ 定期更新依赖包以修复安全漏洞
4. ⚠️ 妥善保管配置文件中的 API 密钥

---

## 技术支持

- 📖 详细技术方案: 参见 `guide.md`
- 🚀 快速开始: 参见 `QUICKSTART.md`
- 💬 问题反馈: 提交 Issue

---

## 更新日志

### v2.0 (2025-10-15)
- ✅ 添加配置文件支持
- ✅ 优化日志记录
- ✅ 改进错误处理
- ✅ 添加演示脚本

### v1.0 (2025-10-15)
- ✅ 基础功能实现
- ✅ 地址筛选
- ✅ 实时监控
- ✅ 持仓追踪

---

**祝您使用愉快！** 🎉

